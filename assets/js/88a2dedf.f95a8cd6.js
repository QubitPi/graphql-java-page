"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[7469],{5680:(e,n,t)=>{t.d(n,{xA:()=>p,yg:()=>h});var a=t(6540);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function l(e,n){if(null==e)return{};var t,a,i=function(e,n){if(null==e)return{};var t,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var c=a.createContext({}),s=function(e){var n=a.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},p=function(e){var n=s(e.components);return a.createElement(c.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},u=a.forwardRef((function(e,n){var t=e.components,i=e.mdxType,r=e.originalType,c=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),u=s(t),h=i,g=u["".concat(c,".").concat(h)]||u[h]||d[h]||r;return t?a.createElement(g,o(o({ref:n},p),{},{components:t})):a.createElement(g,o({ref:n},p))}));function h(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var r=t.length,o=new Array(r);o[0]=u;var l={};for(var c in n)hasOwnProperty.call(n,c)&&(l[c]=n[c]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var s=2;s<r;s++)o[s]=t[s];return a.createElement.apply(null,o)}return a.createElement.apply(null,t)}u.displayName="MDXCreateElement"},3187:(e,n,t)=>{t.r(n),t.d(n,{contentTitle:()=>c,default:()=>u,frontMatter:()=>l,metadata:()=>s,toc:()=>p});var a=t(8168),i=t(8587),r=(t(6540),t(5680)),o=["components"],l={title:"SDL directives",date:new Date("2018-09-09T02:52:46.000Z"),description:"How SDL Directives can be used to adjust the behavior of your graphql API"},c="Directives",s={unversionedId:"directives",id:"directives",isDocsHomePage:!1,title:"SDL directives",description:"How SDL Directives can be used to adjust the behavior of your graphql API",source:"@site/documentation/directives.md",sourceDirName:".",slug:"/directives",permalink:"/documentation/master/directives",editUrl:"https://github.com/graphql-java/graphql-java-page/edit/master/documentation/directives.md",tags:[],version:"current",frontMatter:{title:"SDL directives",date:"2018-09-09T02:52:46.000Z",description:"How SDL Directives can be used to adjust the behavior of your graphql API"},sidebar:"tutorialSidebar",previous:{title:"Data mapping",permalink:"/documentation/master/data-mapping"},next:{title:"Exceptions",permalink:"/documentation/master/exceptions"}},p=[{value:"Adding Behaviour",id:"adding-behaviour",children:[],level:2},{value:"Declaring Directives",id:"declaring-directives",children:[],level:2},{value:"Another Example - Date Formatting",id:"another-example---date-formatting",children:[],level:2},{value:"Chaining Behaviour",id:"chaining-behaviour",children:[],level:2},{value:"Implementing logic for operation directives",id:"implementing-logic-for-operation-directives",children:[],level:2}],d={toc:p};function u(e){var n=e.components,t=(0,i.A)(e,o);return(0,r.yg)("wrapper",(0,a.A)({},d,t,{components:n,mdxType:"MDXLayout"}),(0,r.yg)("h1",{id:"directives"},"Directives"),(0,r.yg)("p",null,(0,r.yg)("a",{parentName:"p",href:"https://spec.graphql.org/draft/#sec-Language.Directives"},"Directives")," are a powerful feature of GraphQL, allowing you to declare additional data to a schema or document. This data can then be used to change runtime execution or type validation behavior."),(0,r.yg)("p",null,"There are two broad categories of directives, schema and operation directives. Schema directives are used on schema elements, and operation directives are used in operations within a GraphQL document."),(0,r.yg)("p",null,'Often, operation directives are also called "query directives", although they can be used in any GraphQL operation. Whilst both names can be used interchangeably, note that GraphQL Java class names use "query directives". '),(0,r.yg)("p",null,"Note for those who love the details: the terminology of directives is a bit confusing. It is technically possible to define a directive that is both a schema and operation directive, in other words, defined for both schema and operation locations. However in practice, this is not common."),(0,r.yg)("h1",{id:"schema-directives"},"Schema Directives"),(0,r.yg)("h2",{id:"adding-behaviour"},"Adding Behaviour"),(0,r.yg)("p",null,"Schema Definition Language (SDL) allows you to define your graphql types in a declarative manner without using code.  However you still need to wire in all the\nlogic that backs those types and their fields."),(0,r.yg)("p",null,"Schema directives allow you to do this.  You can place directives on SDL elements and then write the backing logic\nonce and have it apply in many places."),(0,r.yg)("p",null,'This idea of "writing it once" is the key concept here.  There is only code place where\nlogic needs to be written and it is then applied to all the places in the SDL that have a named directive.'),(0,r.yg)("p",null,"This is a more powerful model than wiring in 10-100s of data fetchers like you might\nwith the conventional runtime wiring."),(0,r.yg)("p",null,"For example imagine you have a type like the following"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-graphql"},"type Employee\n  id : ID\n  name : String!\n  startDate : String!\n  salary : Float\n}\n")),(0,r.yg)("p",null,"Publishing ",(0,r.yg)("inlineCode",{parentName:"p"},"salary")," information to every one who can see this employee's ",(0,r.yg)("inlineCode",{parentName:"p"},"name")," might not be what you want.  Rather you want some sort of access control\nto be in place such that if your role is that of a manager, you can see salaries, otherwise you get no data back."),(0,r.yg)("p",null,"Directives can help you declare this more easily.  Our declaration above would become something like the following:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-graphql"},'directive @auth(role : String!) on FIELD_DEFINITION\n\ntype Employee\n  id : ID\n  name : String!\n  startDate : String!\n  salary : Float @auth(role : "manager")\n}\n')),(0,r.yg)("p",null,"So we have said that only people who have the role ",(0,r.yg)("inlineCode",{parentName:"p"},"manager")," are authorised to see this field.  We can now use this directive on ANY field\nthat needs manager role authorisation."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-graphql"},'directive @auth(role : String!) on FIELD_DEFINITION\n\ntype Employee\n  id : ID\n  name : String!\n  startDate : String!\n  salary : Float @auth(role : "manager")\n}\n\ntype Department {\n  id : ID\n  name : String\n  yearlyOperatingBudget : Float @auth(role : "manager")\n  monthlyMarketingBudget : Float @auth(role : "manager")\n}\n')),(0,r.yg)("p",null,"We now need to wire in the code that can handle any field with this ",(0,r.yg)("inlineCode",{parentName:"p"},"@auth")," directive.  We use ",(0,r.yg)("inlineCode",{parentName:"p"},"graphql.schema.idl.SchemaDirectiveWiring")," to do this."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-java"},'class AuthorisationDirective implements SchemaDirectiveWiring {\n\n    @Override\n    public GraphQLFieldDefinition onField(SchemaDirectiveWiringEnvironment<GraphQLFieldDefinition> environment) {\n        String targetAuthRole = (String) environment.getAppliedDirective().getArgument("role").getArgumentValue().getValue();\n\n        //\n        // build a data fetcher that first checks authorisation roles before then calling the original data fetcher\n        //\n        DataFetcher originalDataFetcher = environment.getFieldDataFetcher();\n        DataFetcher authDataFetcher = new DataFetcher() {\n            @Override\n            public Object get(DataFetchingEnvironment dataFetchingEnvironment) throws Exception {\n                AuthorisationCtx authContext = dataFetchingEnvironment.getGraphQlContext().get("authContext");\n\n                if (authContext.hasRole(targetAuthRole)) {\n                    return originalDataFetcher.get(dataFetchingEnvironment);\n                } else {\n                    return null;\n                }\n            }\n        };\n        //\n        // now change the field definition to have the new authorising data fetcher\n        return environment.setFieldDataFetcher(authDataFetcher);\n    }\n}\n\n//\n// we wire this into the runtime by directive name\n//\nRuntimeWiring.newRuntimeWiring()\n        .directive("auth", new AuthorisationDirective())\n        .build();\n')),(0,r.yg)("p",null,"This has modified the ",(0,r.yg)("inlineCode",{parentName:"p"},"GraphQLFieldDefinition")," so that its original data fetcher will ONLY be called if the current authorisation context\nhas the ",(0,r.yg)("inlineCode",{parentName:"p"},"manager")," role. You can use any mechanism for authorisation, for example Spring Security or anything else."),(0,r.yg)("p",null,'You would provide this authorisation checker into the execution "context" object of the graphql input, so it can then be accessed later in the\n',(0,r.yg)("inlineCode",{parentName:"p"},"DataFetchingEnvironment"),"."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-java"},'AuthorisationCtx authCtx = AuthorisationCtx.obtain();\n\nExecutionInput executionInput = ExecutionInput.newExecutionInput()\n        .query(query)\n        .graphQLContext(builder -> builder.put("authContext", authCtx))\n        .build();\n')),(0,r.yg)("h2",{id:"declaring-directives"},"Declaring Directives"),(0,r.yg)("p",null,"In order to use a directive in SDL, the graphql specification requires that you MUST declare its shape before using it. Our ",(0,r.yg)("inlineCode",{parentName:"p"},"@auth")," directive example above needs to be\ndeclared like so before use."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-graphql"},'# This is a directive declaration\ndirective @auth(role : String!) on FIELD_DEFINITION\n\ntype Employee\n  id : ID\n\n  # and this is a usage of that declared directive\n  salary : Float @auth(role : "manager")\n}\n')),(0,r.yg)("p",null,"The one exception to this is the ",(0,r.yg)("inlineCode",{parentName:"p"},"@deprecated")," directive which is implicitly declared for you as follows:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-graphql"},'directive @deprecated(reason: String = "No longer supported") on FIELD_DEFINITION | ENUM_VALUE\n')),(0,r.yg)("p",null,"The valid SDL directive locations are as follows:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-graphql"},"SCHEMA,\nSCALAR,\nOBJECT,\nFIELD_DEFINITION,\nARGUMENT_DEFINITION,\nINTERFACE,\nUNION,\nENUM,\nENUM_VALUE,\nINPUT_OBJECT,\nINPUT_FIELD_DEFINITION\n")),(0,r.yg)("p",null,"Directives are commonly applied to fields definitions but as you can see there are a number of places they can be applied."),(0,r.yg)("h2",{id:"another-example---date-formatting"},"Another Example - Date Formatting"),(0,r.yg)("p",null,"Date formatting is a cross-cutting concern that we should only have to write once and apply it in many areas."),(0,r.yg)("p",null,"The following demonstrates an example schema directive that can apply date formatting to fields that are ",(0,r.yg)("inlineCode",{parentName:"p"},"LocaleDate")," objects."),(0,r.yg)("p",null,"What's great in this example is that it adds an extra ",(0,r.yg)("inlineCode",{parentName:"p"},"format")," argument to each field that it is applied to. So the clients can\nopt into what ever date formatting you provide per request."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-graphql"},"directive @dateFormat on FIELD_DEFINITION\n\ntype Query {\n  dateField : String @dateFormat\n}\n")),(0,r.yg)("p",null,"Then our runtime code could be :"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-java"},'public static class DateFormatting implements SchemaDirectiveWiring {\n    @Override\n    public GraphQLFieldDefinition onField(SchemaDirectiveWiringEnvironment<GraphQLFieldDefinition> environment) {\n        GraphQLFieldDefinition field = environment.getElement();\n        GraphQLFieldsContainer parentType = environment.getFieldsContainer();\n        //\n        // DataFetcherFactories.wrapDataFetcher is a helper to wrap data fetchers so that CompletionStage is handled correctly\n        // along with POJOs\n        //\n        DataFetcher originalFetcher = environment.getCodeRegistry().getDataFetcher(parentType, field);\n        DataFetcher dataFetcher = DataFetcherFactories.wrapDataFetcher(originalFetcher, ((dataFetchingEnvironment, value) -> {\n            DateTimeFormatter dateTimeFormatter = buildFormatter(dataFetchingEnvironment.getArgument("format"));\n            if (value instanceof LocalDateTime) {\n                return dateTimeFormatter.format((LocalDateTime) value);\n            }\n            return value;\n        }));\n\n        //\n        // This will extend the field by adding a new "format" argument to it for the date formatting\n        // which allows clients to opt into that as well as wrapping the base data fetcher so it\n        // performs the formatting over top of the base values.\n        //\n        FieldCoordinates coordinates = FieldCoordinates.coordinates(parentType, field);\n        environment.getCodeRegistry().dataFetcher(coordinates, dataFetcher);\n\n        return field.transform(builder -> builder\n                .argument(GraphQLArgument\n                        .newArgument()\n                        .name("format")\n                        .type(Scalars.GraphQLString)\n                        .defaultValueProgrammatic("dd-MM-YYYY")\n                )\n        );\n    }\n\n    private DateTimeFormatter buildFormatter(String format) {\n        String dtFormat = format != null ? format : "dd-MM-YYYY";\n        return DateTimeFormatter.ofPattern(dtFormat);\n    }\n}\n\nstatic GraphQLSchema buildSchema() {\n\n    String sdlSpec = "directive @dateFormat on FIELD_DEFINITION\\n" +\n                  "type Query {\\n" +\n                  "    dateField : String @dateFormat \\n" +\n                  "}";\n\n    TypeDefinitionRegistry registry = new SchemaParser().parse(sdlSpec);\n\n    RuntimeWiring runtimeWiring = RuntimeWiring.newRuntimeWiring()\n            .directive("dateFormat", new DateFormatting())\n            .build();\n\n    return new SchemaGenerator().makeExecutableSchema(registry, runtimeWiring);\n}\n\npublic static void main(String[] args) {\n    GraphQLSchema schema = buildSchema();\n    GraphQL graphql = GraphQL.newGraphQL(schema).build();\n\n    Map<String, Object> root = new HashMap<>();\n    root.put("dateField", LocalDateTime.of(1969, 10, 8, 0, 0));\n\n    String query = "" +\n            "query {\\n" +\n            "    default : dateField \\n" +\n            "    usa : dateField(format : \\"MM-dd-YYYY\\") \\n" +\n            "}";\n\n    ExecutionInput executionInput = ExecutionInput.newExecutionInput()\n            .root(root)\n            .query(query)\n            .build();\n\n    ExecutionResult executionResult = graphql.execute(executionInput);\n    Map<String, Object> data = executionResult.getData();\n\n    // data[\'default\'] == \'08-10-1969\'\n    // data[\'usa\'] == \'10-08-1969\'\n}\n')),(0,r.yg)("p",null,"Notice the SDL definition did not have a ",(0,r.yg)("inlineCode",{parentName:"p"},"format")," argument yet once the directive wiring is applied, it is added\nto the field definition and hence clients can begin to use it."),(0,r.yg)("p",null,"Please note that graphql-java does not ship with this implementation. It is merely provided here as\nan example of what you could add yourself."),(0,r.yg)("h2",{id:"chaining-behaviour"},"Chaining Behaviour"),(0,r.yg)("p",null,"The directives are applied in the order they are encountered. For example imagine directives that changed the case of a field value."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-graphql"},"directive @uppercase on FIELD_DEFINITION\ndirective @lowercase on FIELD_DEFINITION\ndirective @mixedcase on FIELD_DEFINITION\ndirective @reversed on FIELD_DEFINITION\n\ntype Query {\n  lowerCaseValue : String @uppercase\n  upperCaseValue : String @lowercase\n  mixedCaseValue : String @mixedcase\n\n  #\n  # directives are applied in order hence this will be lower, then upper, then mixed then reversed\n  #\n  allTogetherNow : String @lowercase @uppercase @mixedcase @reversed\n}\n")),(0,r.yg)("p",null,"When the above was executed each directive would be applied one on top of the other. Each directive implementation should be careful\nto preserve the previous data fetcher to retain behaviour (unless of course you mean to throw it away)"),(0,r.yg)("h1",{id:"operation-directives-also-known-as-query-directives"},"Operation Directives (also known as Query Directives)"),(0,r.yg)("p",null,"Let's define an operation directive ",(0,r.yg)("inlineCode",{parentName:"p"},"@cache"),", which can be used on operation fields. "),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-graphql"},"# Can only be used on a field in a GraphQL document\ndirective @cache on FIELD\n\ntype Query {\n    pet: Pet\n}\n\ntype Pet {\n    name: String\n    lastTimeOutside: String\n}\n")),(0,r.yg)("p",null,"We can only use this ",(0,r.yg)("inlineCode",{parentName:"p"},"@cache")," directive on fields in a GraphQL document, which contains operations."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-graphql"},"query myPet {\n    pet {\n        name\n        lastTimeOutside @cache\n    }\n}\n")),(0,r.yg)("p",null,"Directives can also have arguments. Let's add a ",(0,r.yg)("inlineCode",{parentName:"p"},"maxAge")," argument, with a default value of 1000."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-graphql"},"# Argument with a default value\ndirective @cache(maxAge: Int = 1000) on FIELD\n")),(0,r.yg)("p",null,"In a GraphQL document, we could use our updated ",(0,r.yg)("inlineCode",{parentName:"p"},"@cache")," directive to specify a maxAge value:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-graphql"},"query myPet {\n    pet {\n        name\n        lastTimeOutside @cache(maxAge: 500)\n    }\n}\n")),(0,r.yg)("p",null,"All custom schema and operation directives don't have any effect until we implement new custom behavior. For example, the operation above where ",(0,r.yg)("inlineCode",{parentName:"p"},"lastTimeOutside")," has a ",(0,r.yg)("inlineCode",{parentName:"p"},"@cache")," directive behaves exactly the same as without it, until we have implemented some new logic. We'll demonstrate implementation of behavior for directives in the next section of this page."),(0,r.yg)("p",null,"Here is an operation directive with all possible eight locations in a GraphQL document, which contains operations."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-graphql"},"type @foo on QUERY | MUTATION | SUBSCRIPTION |\n  FIELD | FRAGMENT_DEFINITION | FRAGMENT_SPREAD |\n  INLINE_FRAGMENT | VARIABLE_DEFINITION\n\nquery someQuery(\n    $var: String @foo # Variable definition\n    ) @foo # Query\n    {\n        field @foo  # Field\n        ... on Query @foo { # Inline fragment\n            field\n        }\n        ...someFragment @foo # Fragment spread\n}\n\nfragment someFragment @foo { # Fragment\n    field\n}\n\nmutation someMutation @foo { # Mutation\n    field\n}\n\nsubscription someSubscription @foo { # Subscription\n    field\n}\n")),(0,r.yg)("p",null,"Although it is technically possible to define a directive that includes locations associated with schema and operation directives, in practice this is not common."),(0,r.yg)("h2",{id:"implementing-logic-for-operation-directives"},"Implementing logic for operation directives"),(0,r.yg)("p",null,"Let's implement the logic for a ",(0,r.yg)("inlineCode",{parentName:"p"},"@cache")," operation directive:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-graphql"},"directive @cache(maxAge: Int) on FIELD\n")),(0,r.yg)("p",null,"This is an operation directive that enables clients to specify how recent cache entries must be. This is an example of an operation directive that can change execution."),(0,r.yg)("p",null,"For example, a client specifies that ",(0,r.yg)("inlineCode",{parentName:"p"},"hello")," cache entries must not be older than 500 ms, otherwise we re-fetch these entries."),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-graphql"},"query caching {\n    hello @cache(maxAge: 500)\n}\n")),(0,r.yg)("p",null,"In GraphQL Java, operation directive definitions are represented as ",(0,r.yg)("inlineCode",{parentName:"p"},"GraphQLDirective"),"s. Operation directive usages are represented as ",(0,r.yg)("inlineCode",{parentName:"p"},"QueryAppliedDirective"),'s. Note that the word "query" here is misleading, as it actually refers to a directive that applies to any of the three GraphQL operations: queries, mutations, or subscriptions. Operation directives are still commonly referred to as "query" directives, hence the class name.'),(0,r.yg)("p",null,"Usages of operation directives are represented in GraphQL Java as instances of ",(0,r.yg)("inlineCode",{parentName:"p"},"QueryAppliedDirective"),", and provided argument values are represented as ",(0,r.yg)("inlineCode",{parentName:"p"},"QueryAppliedDirectiveArgument"),"."),(0,r.yg)("p",null,"We can access operation directives usage during execution via ",(0,r.yg)("inlineCode",{parentName:"p"},"getQueryDirectives()")," in ",(0,r.yg)("inlineCode",{parentName:"p"},"DataFetchingEnvironment"),". For example:"),(0,r.yg)("pre",null,(0,r.yg)("code",{parentName:"pre",className:"language-java"},'DataFetcher<?> cacheDataFetcher = new DataFetcher<Object>() {\n    @Override\n    public Object get(DataFetchingEnvironment env) {\n        QueryDirectives queryDirectives = env.getQueryDirectives();\n        List<QueryAppliedDirective> cacheDirectives = queryDirectives\n                .getImmediateAppliedDirective("cache");\n        // We get a List, because we could have\n        // repeatable directives\n        if (cacheDirectives.size() > 0) {\n            QueryAppliedDirective cache = cacheDirectives.get(0);\n            QueryAppliedDirectiveArgument maxAgeArgument\n                    = cache.getArgument("maxAge");\n            int maxAge = maxAgeArgument.getValue();\n\n            // Now we know the max allowed cache time and\n            // can make use of it\n            // Your logic goes here\n        }\n    }\n};\n')))}u.isMDXComponent=!0}}]);