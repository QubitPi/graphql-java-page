<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="alternate" type="application/rss+xml" href="/graphql-java-page/blog/rss.xml" title="GraphQL Java RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/graphql-java-page/blog/atom.xml" title="GraphQL Java Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-126627606-1","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><title data-react-helmet="true">GraphQL Java and Threads | GraphQL Java</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://QubitPi.github.io//graphql-java-page/blog/threads"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="GraphQL Java and Threads | GraphQL Java"><meta data-react-helmet="true" name="description" content="We follow a fundamental rule in GraphQL Java regarding Threads: GraphQL Java never creates"><meta data-react-helmet="true" property="og:description" content="We follow a fundamental rule in GraphQL Java regarding Threads: GraphQL Java never creates"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2021-02-05T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://github.com/andimarek"><link data-react-helmet="true" rel="shortcut icon" href="/graphql-java-page/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://QubitPi.github.io//graphql-java-page/blog/threads"><link data-react-helmet="true" rel="alternate" href="https://QubitPi.github.io//graphql-java-page/blog/threads" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://QubitPi.github.io//graphql-java-page/blog/threads" hreflang="x-default"><link rel="stylesheet" href="/graphql-java-page/assets/css/styles.cf0d1b68.css">
<link rel="preload" href="/graphql-java-page/assets/js/runtime~main.d870872c.js" as="script">
<link rel="preload" href="/graphql-java-page/assets/js/main.f7b2d60a.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/graphql-java-page/"><div class="navbar__logo"><img src="/graphql-java-page/img/logo.png" alt="GraphQL Java logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/graphql-java-page/img/logo.png" alt="GraphQL Java logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">GraphQL Java</b></a><a class="navbar__item navbar__link" href="/graphql-java-page/documentation/getting-started">Documentation</a><a href="https://leanpub.com/graphql-java/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Book</a><a class="navbar__item navbar__link" href="/graphql-java-page/tutorials/getting-started-with-spring-boot">Tutorial</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/graphql-java-page/blog">Blog</a><a class="navbar__item navbar__link" href="/graphql-java-page/about">About</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" href="/graphql-java-page/documentation/getting-started">v20</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/graphql-java-page/documentation/master/getting-started">master</a></li><li><a class="dropdown__link" href="/graphql-java-page/documentation/getting-started">v20</a></li><li><a class="dropdown__link" href="/graphql-java-page/documentation/v19/getting-started">v19</a></li></ul></div><a href="https://github.com/graphql-java/graphql-java" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">ðŸŒœ</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">ðŸŒž</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_q+wC thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_9G5K margin-bottom--md">All posts</div><ul class="sidebarItemList_6T4b"><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/graphql-java-page/blog/release-policy">GraphQL Java release policy</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/graphql-java-page/blog/java-11-required">GraphQL Java will require Java 11</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/graphql-java-page/blog/version-20-released">Version 20 released</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/graphql-java-page/blog/spring-for-graphql">Spring for GraphQL is the recommended Spring integration</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/graphql-java-page/blog/17-released-and-lts">GraphQL Java 17 released and an update about LTS</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/graphql-java-page/blog/spec-releases-are-not-important">GraphQL spec releases are not important</a></li><li class="sidebarItem_cjdF"><a aria-current="page" class="sidebarItemLink_zyXk sidebarItemLinkActive_wcJs" href="/graphql-java-page/blog/threads">GraphQL Java and Threads</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/graphql-java-page/blog/deep-dive-data-fetcher-results">Building efficient data fetchers by looking ahead</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/graphql-java-page/blog/deep-dive-merged-fields">GraphQL Deep Dive Part 1 - merged fields</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/graphql-java-page/blog/graphql-java-spring-support">First release of GraphQL Java Spring</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/graphql-java-page/blog/introducing-extended-scalars">Introducing graphql-java-extended-scalars</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/graphql-java-page/blog/graphql-java-aims-to-be-used-directly">GraphQL Java aims to be used directly</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/graphql-java-page/blog/breaking-changes-and-lts">About breaking changes and Long-term support</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/graphql-java-page/blog/spectrum-and-new-doc">Moving to spectrum and new documentation home</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/graphql-java-page/blog/moving-projects">Moving projects out of the GraphQL Java org</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/graphql-java-page/blog/welcome-to-graphql-java">Welcome to the new GraphQL Java homepage</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_d4p0" itemprop="headline">GraphQL Java and Threads</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2021-02-05T00:00:00.000Z" itemprop="datePublished">February 5, 2021</time> Â· <!-- -->4 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://github.com/andimarek" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://github.com/andimarek.png" alt="Andreas Marek"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/andimarek" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Andreas Marek</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of GraphQL Java</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>We follow a fundamental rule in GraphQL Java regarding Threads: GraphQL Java never creates
Threads or interacts with Thread pools. We do this because we want to give the user the full control
and whatever GraphQL Java would do, it would not be correct for every use case.</p><p>Additionally to being strictly unopinionated regarding Threads, GraphQL Java is also fully reactive,
implemented via <code>CompletableFuture</code> (<code>CF</code>).
These two constrain together mean we rely on the <code>CF</code> returned by the user.
Specifically we piggyback on the <code>CF</code> returned by the <code>DataFetcher</code>
(or other async methods which can be implemented by the user, but we focus here on <code>DataFetcher</code>
as it is by far the most important).</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">// Pseudo code in GraphQL Java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CompletableFuture&lt;Object&gt; dataFetcherResult = invokeDataFetcher();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dataFetcherResult.thenApply(result -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // in which Thread  where this code happens is controlled by the CF returned</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    continueExecutingQuery(result);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><header><h1>Blocking DataFetcher</h1></header><p>Lets assume you are accessing a DB in a blocking way in your <code>DataFetcher</code>:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">String get(DataFetchingEnvironment env) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return getValueFromDb(env); // blocking the Thread until the value is read from DB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This is not completely wrong, but not recommend in general as the consequence of this kind of <code>DataFecher</code>
is that GraphQL can&#x27;t execute the query in the most efficient way.</p><p>For example for the following query:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI graphql"><pre tabindex="0" class="prism-code language-graphql codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dbData1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dbData2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  dbData3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>If the <code>DataFetcher</code> for these <code>dbData</code> fields don&#x27;t return a <code>CF</code>,
but block the Thread until the data is read, GraphQL Java will not work with maximum efficiency.</p><p>GraphQL Java can invoke the <code>DataFetcher</code> for all three fields in parallel. But if your <code>DataFetcher</code> for
<code>dbData1</code> is blocking, GraphQL Java will also be blocked and only invoke the next <code>DataFetcher</code> once <code>dbData&lt;n&gt;</code>
is finished.
The recommend solution to this problem is offloading your blocking code onto a separate Thread pool
as shown here:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">CompletableFuture&lt;String&gt; get(DataFetchingEnvironment env) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return CompletableFuture.supplyAsync( getValueFromDb(env), dbThreadPool );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>This code will maximize the performance and will cause all three fields to be fetched in parallel.</p><header><h1>Different pools for different work</h1></header><p>The subsequent work done by GraphQL Java will be executed in the same <code>dbThreadPool</code> until it
encounters a new <code>DataFetcher</code> returned by the user code and this new <code>CF</code> dedicates the Thread
for the subsequent work.</p><p>If you want to have separate pools for different kind of work, one for the actual <code>DataFetcher</code> which normally
involve IO and one of the actual GraphQL Java work (which is pure CPU), you need to switch back from your offloaded
pool to a dedicated GraphQL Java pool before returning the <code>CF</code>. You can achieve this with code like this:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">CompletableFuture&lt;String&gt; get(DataFetchingEnvironment env) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return CompletableFuture.supplyAsync( getValueFromDb(env), dbThreadPool )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .handleAsync((result,exception) -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if(exception !=null) throw exception;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }, graphqlJavaPool);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Notice the <code>.handleAsync</code> which doesn&#x27;t do anything except forwarding the result, but on a
different pool (<code>graphqlJavaPool</code>).</p><p>This way you have different pools for different kind of work (one for CPU bound GraphQL Java work and one
for multiple ones for IO bound work), which can be configured and monitored independently.</p><header><h1>In a fully reactive system</h1></header><p>If your system is fully reactive your <code>DataFetcher</code> will more look like this</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI java"><pre tabindex="0" class="prism-code language-java codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">CompletableFuture&lt;String&gt; get(DataFetchingEnvironment env) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return callAnotherServiceNonBlocking(env); // returns CompletableFuture</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The code above could be implemented via <a href="https://github.com/AsyncHttpClient/async-http-client" target="_blank" rel="noopener noreferrer">Async Http Client</a>
or <a href="https://docs.spring.io/spring-framework/docs/current/reference/html/web-reactive.html#webflux-client" target="_blank" rel="noopener noreferrer">WebFlux WebClient</a>.
Both provide fully reactive HTTP clients.</p><p>Because the code is non blocking there is no need to offload anything on a dedicated Thread pool to avoid blocking
GraphQL Java.</p><p>You still might want to consider using a dedicated GraphQL Java pool as you otherwise would use
Threads which are dedicated to IO. How much this is really relevant depends highly on your use case.</p><p>For example <code>Async Http Client</code> (<code>AHC</code>) uses by default 2 * #cores (this value comes actually from Netty) Threads. If you
don&#x27;t use a dedicated Thread Pool for GraphQL Java you might encounter situations under load where all <code>AHC</code>
Threads are either busy or blocked by GraphQL Java code and as a result your system is not as performant as it
could be. Normally only load tests in production like environments can show the relevance of different Thread pools.</p><header><h1>Feedback or questions</h1></header><p>We use <a href="https://github.com/graphql-java/graphql-java/discussions" target="_blank" rel="noopener noreferrer">GitHub Discussions</a> for general feedback and questions.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/graphql-java-page/blog/spec-releases-are-not-important"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« <!-- -->GraphQL spec releases are not important</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/graphql-java-page/blog/deep-dive-data-fetcher-results"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Building efficient data fetchers by looking ahead<!-- --> Â»</div></a></div></nav></main></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/graphql-java-page/documentation/getting-started">Documentation</a></li><li class="footer__item"><a class="footer__link-item" href="/graphql-java-page/tutorials/getting-started-with-spring-boot">3 Min Tutorial</a></li><li class="footer__item"><a href="https://javadoc.io/doc/com.graphql-java/graphql-java/" target="_blank" rel="noopener noreferrer" class="footer__link-item">JavaDoc</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/graphql-java/graphql-java/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub Discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/graphql_java" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/graphql-java-page/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/graphql-java/graphql-java" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2023 Andreas Marek.</div></div></div></footer></div>
<script src="/graphql-java-page/assets/js/runtime~main.d870872c.js"></script>
<script src="/graphql-java-page/assets/js/main.f7b2d60a.js"></script>
</body>
</html>